<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æµ·å²›å¥‡å…µ å…¨çƒæ’è¡Œæ¦œ</title>
    <style>
        body {
            font-family: "Segoe UI", "Microsoft YaHei", sans-serif;
            background-color: #1a1a1d;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            background-color: #2c2c2e;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        h1 {
            text-align: center;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.3);
            margin-bottom: 20px;
        }

        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #3e3e40;
        }

        .tab-button {
            flex-grow: 1;
            padding: 12px 0;
            cursor: pointer;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            color: #aaa;
            border: none;
            background: none;
            transition: all 0.3s;
        }

        .tab-button:hover:not(.active) {
            color: #eee;
            background-color: #38383a;
        }

        .tab-button.active {
            color: #ffcc00;
            border-bottom: 3px solid #ffcc00;
            background-color: #38383a;
        }

        /* å†…å®¹å’Œè¡¨æ ¼æ ·å¼ */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px;
        }

        th,
        td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        th {
            background-color: #3a3a3c;
            color: #aaa;
            font-weight: 600;
        }

        tr:hover {
            background-color: #38383a;
        }

        /* æ’åç‰¹æ®Šæ ·å¼ */
        .rank-1 {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2em;
        }

        .rank-2 {
            color: #c0c0c0;
            font-weight: bold;
            font-size: 1.1em;
        }

        .rank-3 {
            color: #cd7f32;
            font-weight: bold;
            font-size: 1.1em;
        }

        .level-badge {
            background: #444;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .error {
            color: #ff6b6b;
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: #333;
            border-radius: 6px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>æµ·å²›å¥‡å…µ å…¨çƒæ’è¡Œæ¦œ</h1>

        <div class="tabs">
            <button class="tab-button active" data-board="VP_GLOBAL">
                ğŸ† å¥–ç‰Œæ¦œ
            </button>
            <button class="tab-button" data-board="CRAB_GLOBAL">
                ğŸ¦€ å·¨å‹èƒèŸ¹æ¦œ
            </button>
            <button class="tab-button" data-board="DEPLOY_STATS">ğŸ’€ ä¼¤äº¡æ¦œ</button>
        </div>

        <div id="VP_GLOBAL_content" class="tab-content active">
            <h2 id="vpTitle">ğŸ† å…¨çƒå¥–ç‰Œæ¦œ (VP)</h2>
            <div id="VP_GLOBAL_error" class="error" style="display: none"></div>
            <table id="VP_GLOBAL_table">
                <tr>
                    <td colspan="4" style="text-align: center">
                        ç‚¹å‡»æ ‡ç­¾é¡µæˆ–ç­‰å¾…åŠ è½½...
                    </td>
                </tr>
            </table>
        </div>

        <div id="CRAB_GLOBAL_content" class="tab-content">
            <h2 id="crabTitle">ğŸ¦€ å…¨çƒå·¨å‹èƒèŸ¹æ¦œ</h2>
            <div id="CRAB_GLOBAL_error" class="error" style="display: none"></div>
            <table id="CRAB_GLOBAL_table">
                <tr>
                    <td colspan="4" style="text-align: center">
                        ç‚¹å‡»æ ‡ç­¾é¡µæˆ–ç­‰å¾…åŠ è½½...
                    </td>
                </tr>
            </table>
        </div>

        <div id="DEPLOY_STATS_content" class="tab-content">
            <h2 id="deployTitle">ğŸ’€ ç©å®¶ä¼¤äº¡æ¦œ (å·²éƒ¨ç½²éƒ¨é˜Ÿæ•°)</h2>
            <div id="DEPLOY_STATS_error" class="error" style="display: none"></div>
            <table id="DEPLOY_STATS_table">
                <tr>
                    <td colspan="4" style="text-align: center">
                        ç‚¹å‡»æ ‡ç­¾é¡µæˆ–ç­‰å¾…åŠ è½½...
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        // ä½¿ç”¨ Cloudflare Workers ä»£ç†è§£å†³ CORS é—®é¢˜
        const rp = "https://rp.30hb.cn/?target=";
        const apiUrl = `${rp}https://webapi.30hb.cn/api/`;

        // å®šä¹‰æ‰€æœ‰æ¦œå•çš„é…ç½®ä¿¡æ¯
        const LEADERBOARDS = {
            VP_GLOBAL: {
                url: `${apiUrl}leaderboard/VP_GLOBAL`,
                title: "ğŸ† å…¨çƒå¥–ç‰Œæ¦œ (VP)",
                scoreLabel: "å¥–ç‰Œæ•° (VP)",
                dataPath: "RankingEntries",
                scoreKey: "Score",
                levelKey: "AvatarLevel",
                nameKey: "Name",
                tableId: "VP_GLOBAL_table",
                errorId: "VP_GLOBAL_error",
            },
            CRAB_GLOBAL: {
                url: `${apiUrl}leaderboard/CRAB_GLOBAL`,
                title: "ğŸ¦€ å…¨çƒå·¨å‹èƒèŸ¹æ¦œ",
                scoreLabel: "èƒèŸ¹åˆ†æ•°",
                dataPath: "RankingEntries",
                scoreKey: "Score",
                levelKey: "AvatarLevel",
                nameKey: "Name",
                tableId: "CRAB_GLOBAL_table",
                errorId: "CRAB_GLOBAL_error",
            },
            // æ³¨æ„ï¼šè¿™ä¸ªæ¥å£è¿”å›çš„æ˜¯ TaskForce ç»“æ„ï¼Œæ•°æ®åˆ—è¡¨åœ¨ AllianceMemberList
            DEPLOY_STATS: {
                url: `${apiUrl}reserved_alliance/RANK_STATS_DEPLOY`,
                title: "ğŸ’€ ç©å®¶ä¼¤äº¡æ¦œ (å·²éƒ¨ç½²éƒ¨é˜Ÿæ•°)",
                scoreLabel: "å·²éƒ¨ç½²éƒ¨é˜Ÿæ•°",
                dataPath: "AllianceMemberList",
                scoreKey: "VictoryPoint", // å¤‡æ³¨ï¼šJSONä¸­æ­¤å­—æ®µåä¸ºVictoryPointï¼Œä½†æè¿°ä¸ºéƒ¨ç½²éƒ¨é˜Ÿæ•°
                levelKey: "Level",
                nameKey: "PlayerName",
                tableId: "DEPLOY_STATS_table",
                errorId: "DEPLOY_STATS_error",
            },
        };

        /**
         * è§£ææ¸¸æˆå†…çš„é¢œè‰²ä»£ç  <cRRGGBB>Name</c> ä¸º HTML span æ ‡ç­¾ã€‚
         */
        function parseGameText(text) {
            if (!text) return "";

            // 1. åŸºæœ¬çš„ HTML è½¬ä¹‰
            let safeText = text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");

            // 2. å°† &lt;cHEX&gt;...&lt;/c&gt; æ›¿æ¢ä¸º HTML span æ ‡ç­¾
            return safeText.replace(
                /&lt;c([0-9a-fA-F]{6})&gt;(.*?)&lt;\/c&gt;/gi,
                function (match, color, content) {
                    // æ³¨æ„ï¼šå› ä¸ºåŸå§‹å†…å®¹å·²ç»è¢«è½¬ä¹‰ï¼Œè¿™é‡Œéœ€è¦è¿˜åŸå†…å®¹ä¸­çš„ < >
                    const unescapedContent = content
                        .replace(/&lt;/g, "<")
                        .replace(/&gt;/g, ">");

                    return `<span style="color: #${color}">${unescapedContent}</span>`;
                }
            );
        }

        /**
         * è·å–æŒ‡å®š URL çš„æ•°æ®å¹¶æ¸²æŸ“åˆ°è¡¨æ ¼ä¸­ã€‚
         * @param {Object} boardConfig - æ¦œå•çš„é…ç½®å¯¹è±¡ã€‚
         */
        async function fetchAndRender(boardConfig) {
            const table = document.getElementById(boardConfig.tableId);
            const errorDiv = document.getElementById(boardConfig.errorId);

            // åˆå§‹çŠ¶æ€
            errorDiv.style.display = "none";

            // è®¾ç½®â€œåŠ è½½ä¸­â€æç¤º
            table.innerHTML = `<thead>
            <tr><th>æ’å</th><th>ç­‰çº§</th><th>ç©å®¶åç§°</th><th>${boardConfig.scoreLabel}</th></tr>
        </thead>
        <tbody>
            <tr><td colspan="4" style="text-align:center;">æ­£åœ¨è¯·æ±‚ ${boardConfig.title} æ•°æ®...</td></tr>
        </tbody>`;

            try {
                const response = await fetch(boardConfig.url);

                if (!response.ok) {
                    // å¦‚æœä»£ç†è¿”å›äº†é200çŠ¶æ€ç ï¼Œå¯èƒ½æ˜¯ä»£ç†è‡ªèº«é—®é¢˜æˆ–ç›®æ ‡æœåŠ¡ä¸å¯ç”¨
                    throw new Error(
                        `HTTP å“åº”å¼‚å¸¸: ${response.status} (å¯èƒ½æ˜¯ä»£ç†æˆ–ç›®æ ‡æœåŠ¡é—®é¢˜)`
                    );
                }

                const json = await response.json();

                // ä¾æ®é…ç½®å¯¹è±¡è·å–æ•°æ®åˆ—è¡¨
                let dataList = json.body ? json.body[boardConfig.dataPath] : null;

                if (!dataList || !Array.isArray(dataList)) {
                    throw new Error("æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œæœªæ‰¾åˆ°æ’è¡Œæ¦œæ¡ç›®ã€‚");
                }

                // æ„å»ºè¡¨æ ¼å¤´éƒ¨ï¼Œç¡®ä¿ scoreLabel æ˜¯åŠ¨æ€çš„
                let tableHTML = `<thead>
                <tr>
                    <th width="10%">æ’å</th>
                    <th width="10%">ç­‰çº§</th>
                    <th width="50%">ç©å®¶åç§°</th>
                    <th width="30%">${boardConfig.scoreLabel}</th>
                </tr>
            </thead><tbody>`;

                // æ¸²æŸ“æ¯ä¸€è¡Œ
                dataList.forEach((item) => {
                    const rank = item.Order || "N/A";
                    // ç¡®ä¿æ­£ç¡®åœ°ä» CRAB_GLOBAL å’Œ DEPLOY_STATS çš„æ•°æ®ä¸­å–é”®
                    const level = item[boardConfig.levelKey] || "-";
                    const name = item[boardConfig.nameKey] || "æœªçŸ¥ç©å®¶";
                    const score = item[boardConfig.scoreKey] || 0;

                    // å¤„ç†å‰ä¸‰åçš„ç‰¹æ®Šæ ·å¼
                    let rankClass = "";
                    if (rank === 1) rankClass = "rank-1";
                    else if (rank === 2) rankClass = "rank-2";
                    else if (rank === 3) rankClass = "rank-3";

                    // è§£æå¸¦æœ‰é¢œè‰²ä»£ç çš„åå­—
                    const formattedName = parseGameText(name);

                    tableHTML += `
                    <tr>
                        <td class="${rankClass}">#${rank}</td>
                        <td><span class="level-badge">Lv.${level}</span></td>
                        <td>${formattedName}</td>
                        <td>${score.toLocaleString()}</td>
                    </tr>
                `;
                });

                tableHTML += "</tbody>";
                table.innerHTML = tableHTML;
            } catch (error) {
                console.error(`Error fetching ${boardConfig.title}:`, error);
                errorDiv.style.display = "block";
                errorDiv.innerHTML = `åŠ è½½å¤±è´¥: ${error.message}<br>
            <small>è¯·ç¡®è®¤ä»£ç†æœåŠ¡ **${rp}** æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œæˆ–å°è¯•ä½¿ç”¨å…¶ä»– CORS è§£å†³æ–¹æ¡ˆã€‚</small>`;
                // æ¸…ç©ºè¡¨æ ¼å¹¶æ˜¾ç¤ºé”™è¯¯æç¤º
                table.innerHTML = `<thead>
                <tr><th>æ’å</th><th>ç­‰çº§</th><th>ç©å®¶åç§°</th><th>${boardConfig.scoreLabel}</th></tr>
            </thead>
            <tbody>
                <tr><td colspan="4" style="text-align:center; color:#ff6b6b;">æ•°æ®åŠ è½½å¤±è´¥</td></tr>
            </tbody>`;
            }
        }

        /**
         * åˆ‡æ¢æ¦œå•æ ‡ç­¾é¡µ
         */
        function switchBoard(boardKey) {
            // ç§»é™¤æ‰€æœ‰å†…å®¹å’ŒæŒ‰é’®çš„ active çŠ¶æ€
            document
                .querySelectorAll(".tab-content")
                .forEach((el) => el.classList.remove("active"));
            document
                .querySelectorAll(".tab-button")
                .forEach((el) => el.classList.remove("active"));

            // æ¿€æ´»å½“å‰å†…å®¹å’ŒæŒ‰é’®
            document.getElementById(boardKey + "_content").classList.add("active");
            document
                .querySelector(`.tab-button[data-board="${boardKey}"]`)
                .classList.add("active");

            // æ£€æŸ¥æ•°æ®æ˜¯å¦å·²åŠ è½½ï¼Œå¦‚æœè¡¨æ ¼å†…å®¹åŒ…å« 'åŠ è½½ä¸­' æˆ– 'ç­‰å¾…åŠ è½½' åˆ™é‡æ–°åŠ è½½
            const table = document.getElementById(boardKey + "_table");
            if (
                table.innerHTML.includes("ç­‰å¾…åŠ è½½") ||
                table.innerHTML.includes("æ•°æ®åŠ è½½å¤±è´¥")
            ) {
                fetchAndRender(LEADERBOARDS[boardKey]);
            }
        }

        // ç»‘å®šäº‹ä»¶
        document.querySelectorAll(".tab-button").forEach((button) => {
            button.addEventListener("click", () => {
                const boardKey = button.getAttribute("data-board");
                switchBoard(boardKey);
            });
        });

        // é¡µé¢åŠ è½½å®Œæˆåï¼Œè‡ªåŠ¨åŠ è½½å¹¶æ˜¾ç¤ºé»˜è®¤çš„å¥–ç‰Œæ¦œ
        document.addEventListener("DOMContentLoaded", () => {
            // åˆå§‹åŒ–æ—¶è°ƒç”¨ fetchAndRender åŠ è½½é»˜è®¤æ¦œå•
            switchBoard("VP_GLOBAL");
        });
    </script>
</body>

</html>